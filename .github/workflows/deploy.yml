name: Deploy to EC2

on:
  push:
    branches:
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build with Gradle
      run: ./gradlew clean build -x test

    - name: Create SSH key file
      run: |
        echo "${{ secrets.EC2_SSH_KEY }}" > private_key.pem
        chmod 600 private_key.pem

    - name: Deploy to EC2
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
      run: |
        # SSH 디렉토리 생성
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh

        # SSH known_hosts에 EC2 추가 (fingerprint 확인 스킵)
        ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

        # JAR 파일 업로드
        scp -i private_key.pem build/libs/server-0.0.1-SNAPSHOT.jar $EC2_USER@$EC2_HOST:~/mudosa/app.jar

        # 애플리케이션 재시작
        ssh -i private_key.pem $EC2_USER@$EC2_HOST << 'EOF'
          # 기존 프로세스 종료
          pkill -f app.jar || true

          # 새 애플리케이션 시작 (.env 파일 로드)
          cd ~/mudosa
          set -a
          source .env
          set +a
          nohup java -jar -Dspring.profiles.active=prod app.jar > app.log 2>&1 &

          # 시작 대기 (애플리케이션 시작까지 충분한 시간)
          echo "Waiting for application to start..."
          sleep 25

          # 헬스체크 (SERVER_PORT 환경변수 사용, 기본값 8080)
          PORT=${SERVER_PORT:-8080}
          if curl -s http://localhost:$PORT/actuator/health | grep -q "errorCode\|status"; then
            echo "Application started successfully on port $PORT"
          else
            echo "Application health check failed on port $PORT"
            tail -50 ~/mudosa/app.log
            exit 1
          fi
        EOF

    - name: Cleanup
      if: always()
      run: rm -f private_key.pem