name: Deploy to EC2

on:
  push:
    branches:
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build with Gradle
      run: ./gradlew clean build -x test

    - name: Create SSH key file
      run: |
        echo "${{ secrets.EC2_SSH_KEY }}" > private_key.pem
        chmod 600 private_key.pem

    - name: Deploy and Configure EC2
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
      run: |
        # SSH 디렉토리 설정
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

        # JAR 파일 업로드
        scp -i private_key.pem build/libs/server-0.0.1-SNAPSHOT.jar $EC2_USER@$EC2_HOST:~/mudosa/app.jar

        # EC2 내부 설정
        ssh -i private_key.pem $EC2_USER@$EC2_HOST bash << 'REMOTE'

        # start.sh 생성
        echo '#!/bin/bash' > ~/mudosa/start.sh
        echo 'set -a' >> ~/mudosa/start.sh
        echo 'source /home/ec2-user/mudosa/.env' >> ~/mudosa/start.sh
        echo 'set +a' >> ~/mudosa/start.sh
        echo 'exec /opt/java/temurin-21/bin/java -Dserver.address=0.0.0.0 -Dspring.profiles.active=prod -Dfcm.service-acount-file=${FCM_SERVICE_ACCOUNT_FILE} -Dfcm.topic-name=${FCM_TOPIC_NAME} -Dfcm.project-id=${FCM_PROJECT_ID} -jar /home/ec2-user/mudosa/app.jar' >> ~/mudosa/start.sh
        chmod +x ~/mudosa/start.sh

        # mudosa.service 생성
        echo '[Unit]' | sudo tee /etc/systemd/system/mudosa.service
        echo 'Description=Mudosa Spring Boot Application' | sudo tee -a /etc/systemd/system/mudosa.service
        echo 'After=network.target' | sudo tee -a /etc/systemd/system/mudosa.service
        echo '' | sudo tee -a /etc/systemd/system/mudosa.service
        echo '[Service]' | sudo tee -a /etc/systemd/system/mudosa.service
        echo 'User=ec2-user' | sudo tee -a /etc/systemd/system/mudosa.service
        echo 'Type=simple' | sudo tee -a /etc/systemd/system/mudosa.service
        echo 'WorkingDirectory=/home/ec2-user/mudosa/' | sudo tee -a /etc/systemd/system/mudosa.service
        echo 'ExecStart=/home/ec2-user/mudosa/start.sh' | sudo tee -a /etc/systemd/system/mudosa.service
        echo 'Restart=always' | sudo tee -a /etc/systemd/system/mudosa.service
        echo 'RestartSec=10' | sudo tee -a /etc/systemd/system/mudosa.service
        echo '' | sudo tee -a /etc/systemd/system/mudosa.service
        echo '[Install]' | sudo tee -a /etc/systemd/system/mudosa.service
        echo 'WantedBy=multi-user.target' | sudo tee -a /etc/systemd/system/mudosa.service

        # systemd 재시작
        sudo systemctl daemon-reload
        sudo systemctl restart mudosa.service

        # 시작 대기
        echo "Waiting for application to start..."
        sleep 30

        # 헬스체크
        if curl -s http://localhost:8080/actuator/health | grep -q "status"; then
          echo "Application started successfully on port 8080"
        else
          echo "Application health check failed on port 8080"
          sudo journalctl -u mudosa.service -n 50
          exit 1
        fi
        REMOTE

    - name: Cleanup
      if: always()
      run: rm -f private_key.pem