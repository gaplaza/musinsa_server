<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mudosa.musinsa.domain.orders.mapper.OrderMapper">

    <!-- ResultMap 예시 -->
    <resultMap id="OrderResultMap" type="com.mudosa.musinsa.domain.orders.entity.Order">
        <id property="orderId" column="order_id"/>
        <result property="userId" column="user_id"/>
        <result property="couponId" column="coupon_id"/>
        <result property="brandId" column="brand_id"/>
        <result property="orderStatus" column="order_status"/>
        <result property="orderNo" column="order_no"/>
        <result property="totalPrice" column="total_price"/>
        <result property="totalDiscount" column="total_discount"/>
        <result property="finalPaymentAmount" column="final_payment_amount"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="isSettleable" column="is_settleable"/>
        <result property="settledAt" column="settled_at"/>
    </resultMap>

    <!-- 주문 조회 예시 -->
    <select id="findById" parameterType="long" resultMap="OrderResultMap">
        SELECT *
        FROM `Order`
        WHERE order_id = #{orderId}
    </select>

    <!-- 사용자별 주문 목록 조회 -->
    <select id="findByUserId" parameterType="int" resultMap="OrderResultMap">
        SELECT *
        FROM `Order`
        WHERE user_id = #{userId}
        ORDER BY created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 주문 상태별 집계 (통계 쿼리 예시) -->
    <select id="countByStatus" resultType="map">
        SELECT 
            sc.status_code AS status,
            COUNT(*) AS count
        FROM `Order` o
        JOIN status_codes sc ON o.order_status = sc.status_code_id
        WHERE o.created_at BETWEEN #{startDate} AND #{endDate}
        GROUP BY o.order_status, sc.status_code
    </select>

    <!-- 복잡한 조인 쿼리 예시 -->
    <select id="findOrderWithDetails" parameterType="long" resultType="map">
        SELECT 
            o.order_id,
            o.order_no,
            o.total_price,
            o.final_payment_amount,
            o.created_at,
            sc.status_code AS order_status_name,
            COUNT(op.order_product_id) AS product_count
        FROM `Order` o
        LEFT JOIN status_codes sc ON o.order_status = sc.status_code_id
        LEFT JOIN OrderProduct op ON o.order_id = op.order_id
        WHERE o.order_id = #{orderId}
        GROUP BY o.order_id, o.order_no, o.total_price, o.final_payment_amount, 
                 o.created_at, sc.status_code
    </select>

</mapper>
