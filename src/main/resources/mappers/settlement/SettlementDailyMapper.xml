<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mudosa.musinsa.settlement.domain.repository.SettlementDailyMapper">

    <!-- Phase 2: Batch INSERT -->
    <insert id="batchInsert">
        INSERT INTO settlements_daily (
            settlement_number,
            brand_id,
            settlement_date,
            settlement_timezone,
            total_order_count,
            total_sales_amount,
            total_commission_amount,
            total_tax_amount,
            total_pg_fee_amount,
            final_settlement_amount,
            settlement_status,
            aggregated_at,
            confirmed_at,
            completed_at,
            created_at,
            updated_at
        ) VALUES
        <foreach collection="list" item="item" separator=",">
            (
                #{item.settlementNumber},
                #{item.brandId},
                #{item.settlementDate},
                #{item.settlementTimezone},
                #{item.totalOrderCount},
                #{item.totalSalesAmount.amount},
                #{item.totalCommissionAmount.amount},
                #{item.totalTaxAmount.amount},
                #{item.totalPgFeeAmount.amount},
                #{item.finalSettlementAmount.amount},
                #{item.settlementStatus},
                #{item.aggregatedAt},
                #{item.confirmedAt},
                #{item.completedAt},
                NOW(),
                NOW()
            )
        </foreach>
    </insert>

    <!-- 주간 집계 쿼리 -->
    <select id="aggregateByWeekly" resultType="com.mudosa.musinsa.settlement.application.dto.WeeklyAggregationDto">
        SELECT
            brand_id as brandId,
            YEAR(settlement_date) as "year",
            MONTH(MIN(settlement_date)) as "month",
            WEEK(settlement_date) as weekOfMonth,
            MIN(settlement_date) as weekStartDate,
            MAX(settlement_date) as weekEndDate,
            COALESCE(SUM(total_order_count), 0) as totalOrderCount,
            COALESCE(SUM(total_sales_amount), 0) as totalSalesAmount,
            COALESCE(SUM(total_commission_amount), 0) as totalCommissionAmount,
            COALESCE(SUM(total_tax_amount), 0) as totalTaxAmount,
            COALESCE(SUM(total_pg_fee_amount), 0) as totalPgFeeAmount
        FROM settlements_daily
        WHERE settlement_date BETWEEN #{startDate} AND #{endDate}
          AND settlement_status = 'CONFIRMED'
        GROUP BY brand_id, YEAR(settlement_date), WEEK(settlement_date)
        ORDER BY brand_id, YEAR(settlement_date), WEEK(settlement_date)
    </select>

    <!-- 월간 집계 쿼리 -->
    <select id="aggregateByMonthly" resultType="com.mudosa.musinsa.settlement.application.dto.MonthlyAggregationDto">
        SELECT
            brand_id as brandId,
            YEAR(settlement_date) as "year",
            MONTH(settlement_date) as "month",
            COALESCE(SUM(total_order_count), 0) as totalOrderCount,
            COALESCE(SUM(total_sales_amount), 0) as totalSalesAmount,
            COALESCE(SUM(total_commission_amount), 0) as totalCommissionAmount,
            COALESCE(SUM(total_tax_amount), 0) as totalTaxAmount,
            COALESCE(SUM(total_pg_fee_amount), 0) as totalPgFeeAmount
        FROM settlements_daily
        WHERE settlement_date BETWEEN #{startDate} AND #{endDate}
          AND settlement_status = 'CONFIRMED'
        GROUP BY brand_id, YEAR(settlement_date), MONTH(settlement_date)
        ORDER BY brand_id, YEAR(settlement_date), MONTH(settlement_date)
    </select>

</mapper>
