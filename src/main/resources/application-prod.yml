# ========================================
# 프로덕션 환경 설정 (Prod Profile)
# ========================================
spring:
  # DataSource 설정
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://${DB_HOST}:${DB_PORT:3306}/${DB_NAME}?useSSL=true&requireSSL=true&serverTimezone=Asia/Seoul&characterEncoding=UTF-8&rewriteBatchedStatements=true&cachePrepStmts=true&useServerPrepStmts=true
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
    
    # HikariCP 설정 (프로덕션 환경 - 최적화)
    hikari:
      pool-name: HikariCP-Prod
      maximum-pool-size: 20  # 프로덕션은 크게
      minimum-idle: 10
      connection-timeout: 30000
      idle-timeout: 300000
      max-lifetime: 1800000
      auto-commit: false
      connection-test-query: SELECT 1
      leak-detection-threshold: 120000  # 커넥션 누수 감지 (2분)
      
      # 성능 최적화 설정
      data-source-properties:
        cachePrepStmts: true
        prepStmtCacheSize: 250
        prepStmtCacheSqlLimit: 2048
        useServerPrepStmts: true
        useLocalSessionState: true
        rewriteBatchedStatements: true
        cacheResultSetMetadata: true
        cacheServerConfiguration: true
        elideSetAutoCommits: true
        maintainTimeStats: false

  # JPA 프로덕션 환경 설정
  jpa:
    hibernate:
      ddl-auto: none  # 프로덕션에서는 절대 사용 안 함
      naming:
        physical-strategy: org.hibernate.boot.model.naming.CamelCaseToUnderscoresNamingStrategy
    show-sql: false  # SQL 로깅 비활성화 (성능)
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQLDialect
        generate_statistics: false  # 통계 비활성화 (성능)

  # MyBatis 프로덕션 환경 설정
  mybatis:
    configuration:
      log-impl: org.apache.ibatis.logging.nologging.NoLoggingImpl  # 로깅 비활성화
      cache-enabled: true  # 캐시 최대 활용
      local-cache-scope: SESSION
      default-fetch-size: 200
      default-statement-timeout: 60
      default-executor-type: REUSE

  # 정적 리소스 캐싱 활성화
  web:
    resources:
      cache:
        cachecontrol:
          max-age: 31536000  # 1년
          cache-public: true
      chain:
        strategy:
          content:
            enabled: true
        cache: true

  # Spring Batch 프로덕션 환경 설정
  batch:
    jdbc:
      initialize-schema: never
    job:
      enabled: false  # 배치 비활성화 (개발 환경과 동일)

# ========================================
# 프로덕션 환경 로깅 설정 (최소화)
# ========================================
logging:
  level:
    root: warn
    com.mudosa.musinsa: info
    
    # JPA 로깅 최소화
    org.hibernate.SQL: warn
    org.hibernate.type: warn
    org.hibernate.stat: warn
    
    # MyBatis 로깅 최소화
    com.mudosa.musinsa.domain: warn
    
    # Spring 로깅 최소화
    org.springframework: warn
    org.springframework.web: warn
    org.springframework.security: warn
    org.springframework.jdbc: warn
    
    # HikariCP 로깅 최소화
    com.zaxxer.hikari: warn
  
  # 파일 로깅 설정
  file:
    name: /var/log/mudosa/application.log
    max-size: 100MB
    max-history: 30
    total-size-cap: 3GB
  
  pattern:
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"

# ========================================
# JWT 프로덕션 환경 설정
# ========================================
jwt:
  secret: ${JWT_SECRET}  # 반드시 환경 변수로 설정 (256bit 이상)
  access-token-expiration: ${JWT_ACCESS_EXPIRATION:1800000}  # 30분 (보안 강화)
  refresh-token-expiration: ${JWT_REFRESH_EXPIRATION:1209600000}  # 14일

# ========================================
# Swagger 프로덕션 환경 설정 (비활성화)
# ========================================
springdoc:
  swagger-ui:
    enabled: false  # 프로덕션에서는 Swagger 비활성화
  api-docs:
    enabled: false

# ========================================
# Server 프로덕션 환경 설정
# ========================================
server:
  error:
    include-stacktrace: never  # 스택트레이스 노출 안 함
    include-exception: false  # 예외 상세 노출 안 함
    include-message: on_param  # 파라미터 있을 때만
    include-binding-errors: never
  
  # HTTP/2 활성화
  http2:
    enabled: true
  
  # Compression 설정
  compression:
    enabled: true
    min-response-size: 1024
    mime-types: application/json,application/xml,text/html,text/xml,text/plain,application/javascript,text/css


# ========================================
# Management / Actuator (프로덕션 환경 - 제한적)
# ========================================
management:
  endpoints:
    web:
      exposure:
        include: health,metrics,prometheus  # info 제외 (보안)
      base-path: /actuator
  endpoint:
    health:
      show-details: when-authorized  # 인증된 사용자만
      probes:
        enabled: true  # Kubernetes 준비
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}
      environment: prod

# ========================================
# 프로덕션 추가 설정
# ========================================

# Graceful Shutdown 설정
spring.lifecycle:
  timeout-per-shutdown-phase: 30s

# 커넥션 풀 모니터링
decorator.datasource:
  enabled: false  # p6spy 등 비활성화 (성능)

# ========================================
# FCM 프로덕션 환경 설정
# ========================================
fcm:
  service-acount-file: ${FCM_SERVICE_ACCOUNT_FILE:key/fdbdproject.json}
  topic-name: ${FCM_TOPIC_NAME:fdbdMessage}
  project-id: ${FCM_PROJECT_ID:fdbdproject}

# ========================================
# Toss Payments 프로덕션 환경 설정
# ========================================
tosspayments:
  secret-key: ${TOSS_SECRET_KEY:test_gsk_docs_OaPz8L5KdmQXkzRz3y47BMw6}
  client-key: ${TOSS_CLIENT_KEY:test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm}

# ========================================
# 배치 처리 설정
# ========================================
batch:
  settlement:
    chunk-size: ${BATCH_CHUNK_SIZE:10}
    max-skip-count: ${BATCH_MAX_SKIP_COUNT:100}
